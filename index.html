<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Lucas Koh Golf Swing Analysis</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Arial', sans-serif; background: linear-gradient(to bottom, #e6f4ea, #ffffff); color: #333; touch-action: manipulation; -webkit-user-select: none; user-select: none; width: 100%; height: 100vh; overflow: hidden; position: relative; }
        .container { width: 100%; height: 100%; padding: 5%; box-sizing: border-box; background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow-y: auto; -webkit-overflow-scrolling: touch; }
        h1 { text-align: center; font-size: 1.8em; margin-bottom: 5%; color: #28a745; }
        label { display: block; position: relative; padding: 3% 5%; margin: 2% 0; background: #28a745; color: white; border-radius: 10px; cursor: pointer; text-align: center; font-weight: bold; transition: background 0.3s, transform 0.2s; }
        label:hover { background: #218838; transform: translateY(-2px); }
        input[type="file"] { opacity: 0; position: absolute; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer; }
        button { padding: 3% 5%; background: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: background 0.3s, transform 0.2s; width: 100%; }
        button:hover { background: #0069d9; transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .preview-container { text-align: center; margin: 2% 0; }
        .preview-canvas { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: filter 0.3s; }
        .slider-container { margin: 2% 0; text-align: center; }
        input[type="range"] { width: 100%; accent-color: #007bff; -webkit-appearance: none; height: 8px; background: #ddd; border-radius: 5px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #007bff; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.2); cursor: pointer; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; display: none; background: rgba(0,0,0,0.8); z-index: 10; overflow: auto; -webkit-overflow-scrolling: touch; touch-action: pan-x pan-y pinch-zoom; }
        #overlay-canvas-container { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; box-sizing: border-box; }
        #overlay-canvas { width: auto; height: auto; max-width: 100%; max-height: 100%; transition: opacity 0.3s; }
        .overlay-buttons { position: fixed; bottom: 5%; left: 50%; transform: translateX(-50%); display: flex; gap: 5%; z-index: 20; }
        .overlay-buttons button { width: auto; padding: 2% 4%; border-radius: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .overlay-buttons button:hover { transform: translateY(-2px); }
        .loading { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 5vw; height: 5vw; animation: spin 1s linear infinite; margin: 2% auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Media Queries for Different Cellular Sizes */
        @media (max-width: 320px) {
            h1 { font-size: 1.5em; }
            label { padding: 2% 3%; }
            button { padding: 2% 3%; }
            .overlay-buttons button { padding: 1.5% 3%; }
        }
        @media (min-width: 321px) and (max-width: 375px) {
            h1 { font-size: 1.6em; }
            label { padding: 2.5% 4%; }
            button { padding: 2.5% 4%; }
            .overlay-buttons button { padding: 2% 3.5%; }
        }
        @media (min-width: 376px) and (max-width: 425px) {
            h1 { font-size: 1.8em; }
            label { padding: 3% 5%; }
            button { padding: 3% 5%; }
            .overlay-buttons button { padding: 2% 4%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Lucas Koh Golf Swing Analysis</h1>
        <label for="p1Input" aria-label="Select P-1 Setup Photo">Select P-1 (Setup) from Photos
            <input type="file" id="p1Input" accept="image/*" aria-required="true">
        </label>
        <div class="preview-container" id="previewP1" style="display: none;">
            <canvas id="previewCanvasP1" class="preview-canvas"></canvas>
            <div id="loadingP1" class="loading"></div>
        </div>
        <label for="p7Input" aria-label="Select P-7 Impact Photo">Select P-7 (Impact) from Photos
            <input type="file" id="p7Input" accept="image/*" aria-required="true">
        </label>
        <div class="preview-container" id="previewP7" style="display: none;">
            <canvas id="previewCanvasP7" class="preview-canvas"></canvas>
            <div id="loadingP7" class="loading"></div>
        </div>
        <div class="slider-container" id="sliderP7" style="display: none;">
            <label for="sharpnessP7">P-7 Sharpness: <span id="sharpP7Val">100%</span></label>
            <input type="range" id="sharpnessP7" min="50" max="200" value="100" aria-valuemin="50" aria-valuemax="200" aria-valuenow="100">
        </div>
        <button id="showOverlayBtn" disabled aria-label="Show Overlay">Show Overlay</button>
    </div>

    <div id="overlay" role="dialog" aria-modal="true">
        <div id="overlay-canvas-container">
            <canvas id="overlayCanvas"></canvas>
        </div>
        <div class="overlay-buttons">
            <button id="toggleBtn" aria-label="Toggle Mode">Toggle Mode</button>
            <button id="closeBtn" aria-label="Close Overlay">Close</button>
        </div>
    </div>

    <script>
        const p1Input = document.getElementById('p1Input');
        const p7Input = document.getElementById('p7Input');
        const showOverlayBtn = document.getElementById('showOverlayBtn');
        const overlay = document.getElementById('overlay');
        const toggleBtn = document.getElementById('toggleBtn');
        const closeBtn = document.getElementById('closeBtn');
        const previewP1 = document.getElementById('previewP1');
        const previewCanvasP1 = document.getElementById('previewCanvasP1');
        const loadingP1 = document.getElementById('loadingP1');
        const previewP7 = document.getElementById('previewP7');
        const previewCanvasP7 = document.getElementById('previewCanvasP7');
        const loadingP7 = document.getElementById('loadingP7');
        const sliderP7 = document.getElementById('sliderP7');
        const sharpnessP7 = document.getElementById('sharpnessP7');
        const sharpP7Val = document.getElementById('sharpP7Val');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const overlayContainer = document.getElementById('overlay-canvas-container');

        let p1Image, p7Image, p1SilhouetteData, toggleState = 0;
        let sharpValP7 = 100;

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        p1Input.addEventListener('change', (e) => handleUpload(e, 'p1'));
        p7Input.addEventListener('change', (e) => handleUpload(e, 'p7'));

        function handleUpload(e, type) {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                alert('Please upload a valid image file.');
                return;
            }
            const loading = type === 'p1' ? loadingP1 : loadingP7;
            const preview = type === 'p1' ? previewP1 : previewP7;
            const slider = type === 'p7' ? sliderP7 : null;
            loading.style.display = 'block';
            preview.style.display = 'block';
            if (slider) slider.style.display = 'block';

            const img = new Image();
            const reader = new FileReader();
            reader.onload = (event) => {
                img.src = event.target.result;
                img.onload = () => {
                    if (type === 'p1') {
                        p1Image = img;
                        p1SilhouetteData = createSilhouette(img);
                        drawCanvas(previewCanvasP1, p1Image);
                    } else {
                        p7Image = img;
                        drawCanvas(previewCanvasP7, p7Image, `contrast(${sharpValP7}%) brightness(110%)`);
                    }
                    loading.style.display = 'none';
                    checkReady();
                };
            };
            reader.readAsDataURL(file);
        }

        function checkReady() {
            if (p1Image && p7Image) {
                showOverlayBtn.disabled = false;
            }
        }

        const debouncedUpdate = debounce(updatePreviews, 100);

        sharpnessP7.addEventListener('input', (e) => {
            sharpValP7 = e.target.value;
            sharpP7Val.textContent = `${sharpValP7}%`;
            debouncedUpdate();
        });

        function updatePreviews() {
            if (p1Image) drawCanvas(previewCanvasP1, p1Image);
            if (p7Image) drawCanvas(previewCanvasP7, p7Image, `contrast(${sharpValP7}%) brightness(110%)`);
            if (overlay.style.display === 'flex') drawOverlay();
        }

        function createSilhouette(img) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            // Grayscale
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                data[i] = data[i+1] = data[i+2] = avg;
            }

            // Sobel edge detection with fixed threshold 50
            const sobelData = new Uint8ClampedArray(data.length);
            const width = canvas.width;
            const height = canvas.height;

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const i = (y * width + x) * 4;
                    const gx = -data[i-4] + data[i+4] - 2*data[i-width*4] + 2*data[i+width*4] - data[i-4+width*4] + data[i+4+width*4];
                    const gy = -data[i-width*4-4] - 2*data[i-width*4] - data[i-width*4+4] + data[i+width*4-4] + 2*data[i+width*4] + data[i+width*4+4];
                    const magnitude = Math.sqrt(gx*gx + gy*gy);
                    const edge = magnitude > 50 ? 255 : 0;
                    sobelData[i] = sobelData[i+1] = sobelData[i+2] = edge;
                    sobelData[i+3] = 255;
                }
            }

            // Dilate edges slightly
            const dilatedData = new Uint8ClampedArray(sobelData);
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const i = (y * width + x) * 4;
                    if (sobelData[i] === 255) {
                        dilatedData[i-4] = dilatedData[i-4+1] = dilatedData[i-4+2] = 255;
                        dilatedData[i+4] = dilatedData[i+4+1] = dilatedData[i+4+2] = 255;
                        dilatedData[i-width*4] = dilatedData[i-width*4+1] = dilatedData[i-width*4+2] = 255;
                        dilatedData[i+width*4] = dilatedData[i+width*4+1] = dilatedData[i+width*4+2] = 255;
                    }
                }
            }

            // Set background transparent
            for (let i = 0; i < dilatedData.length; i += 4) {
                if (dilatedData[i] === 255) {
                    dilatedData[i] = dilatedData[i+1] = dilatedData[i+2] = 255; // White edges
                } else {
                    dilatedData[i+3] = 0; // Transparent
                }
            }

            ctx.putImageData(new ImageData(dilatedData, width, height), 0, 0);
            return canvas.toDataURL();
        }

        function drawCanvas(canvas, img, filter = '') {
            canvas.width = img.width / 2;
            canvas.height = img.height / 2;
            const ctx = canvas.getContext('2d');
            ctx.filter = filter;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }

        showOverlayBtn.addEventListener('touchend', (e) => openOverlay(e));
        showOverlayBtn.addEventListener('click', (e) => openOverlay(e));

        function openOverlay(e) {
            e.preventDefault();
            if (!p1Image || !p7Image) return;
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            toggleState = 0; // Reset to P-1 on open
            drawOverlay();
        }

        toggleBtn.addEventListener('touchend', (e) => toggleMode(e));
        toggleBtn.addEventListener('click', (e) => toggleMode(e));

        function toggleMode(e) {
            e.preventDefault();
            toggleState = (toggleState + 1) % 3; // Cycle through 0, 1, 2
            drawOverlay();
        }

        closeBtn.addEventListener('touchend', (e) => closeOverlay(e));
        closeBtn.addEventListener('click', (e) => closeOverlay(e));

        function closeOverlay(e) {
            e.preventDefault();
            overlay.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function drawOverlay() {
            overlayCanvas.width = Math.max(p1Image.width, p7Image.width);
            overlayCanvas.height = Math.max(p1Image.height, p7Image.height);
            const ctx = overlayCanvas.getContext('2d');
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

            if (toggleState === 0) {
                // Show P-1
                ctx.filter = 'none';
                ctx.drawImage(p1Image, 0, 0, p1Image.width, p1Image.height);
            } else if (toggleState === 1) {
                // Show P-7
                ctx.filter = `contrast(${sharpValP7}%) brightness(110%)`;
                ctx.drawImage(p7Image, 0, 0, p7Image.width, p7Image.height);
            } else {
                // Show combined overlay
                ctx.filter = `contrast(${sharpValP7}%) brightness(110%)`;
                ctx.drawImage(p7Image, 0, 0, p7Image.width, p7Image.height);
                ctx.filter = 'none';
                ctx.globalAlpha = 0.5;
                ctx.drawImage(p1Image, 0, 0, p1Image.width, p1Image.height);
                ctx.globalAlpha = 1;
            }

            // Ensure the canvas fits within the viewport, centered
            const scale = Math.min(window.innerWidth / overlayCanvas.width, window.innerHeight / overlayCanvas.height);
            overlayCanvas.style.transform = `scale(${scale})`;
            overlayCanvas.style.transformOrigin = '0 0';
            overlayContainer.style.width = `${overlayCanvas.width}px`;
            overlayContainer.style.height = `${overlayCanvas.height}px`;
        }

        // Accessibility
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && overlay.style.display === 'flex') closeOverlay(e);
        });
    </script>
</body>
</html>